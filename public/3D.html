<!DOCTYPE html>
<html>

<head>
    <title>Hello, WebVR! - Multi User A-Frame</title>
    <meta name="description" content="Hello, WebVR! - Multi User A-Frame">
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
</head>

<body>
    <a-scene backgournd="color:rgb(0,0,0);">
        <a-assets timeout="20000">
            <img id="stone_texture" src="/asset/stone.jpg" crossorigin="anonymous">
            <img id="water_texture" src="/asset/water.jpg" crossorigin="anonymous">
            <a-mixin id="sphere" position="0 0.6 0" geometry="primitive:sphere; radius:0.15;"
            material="color:rgb(255, 255, 0)"
            animation__click="property:position.y; from:0.55; to:0.60; startEvent:click; dur:300" shadow></a-mixin>
        </a-assets>
        <a-entity environment="preset: dream; sunPosition: 1 5 -2; groundColor: #742"><a-entity></a-entity>
        <a-entity camera wasd-controls look-controls position="0 1.6 0">
            <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
            <a-entity light="type:spot; intensity:1.4; castShadow:true; shadowBias:-0.0005; angle:40; penumbra:0.3;"
                position="0.5 -0.5 0" rotation="0 0 0"></a-entity>
        </a-entity>

        <!--<a-entity class="ground" geometry="primitive:plane; width:14; height:14;" material="color:white;"
            position="0 0.01 0" rotation="-90 0 0"> </a-entity>-->

        <a-text id="timer" text="align: center; width: 3; font: https://cdn.aframe.io/fonts/Aileron-Semibold.fnt; value: Timer" position="0 0.6 -1" wrap-count="15" rotation="-90 0 0" color="cyan"></a-text>
        
        <!-- button -->
        <a-entity id="playtogather" position="2 0.6 -1">
            <a-entity class="button interactive" position="0 0.6 0"
                geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(255, 0, 255)"
                animation__click="property:position.y; from:0.55; to:0.60; startEvent:click; dur:300" shadow></a-entity>
            <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; height:0.5; depth:0.5;"
                material="color:rgb(255, 255, 255)" shadow></a-entity>
        </a-entity>

        <a-entity id="playagainst" position="-2 0.6 -1">
            <a-entity class="button interactive" position="0 0.6 0"
                geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(0, 255, 255)"
                animation__click="property:position.y; from:0.55; to:0.60; startEvent:click; dur:300" shadow></a-entity>
            <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; height:0.5; depth:0.5;"
                material="color:rgb(255, 255, 255)" shadow></a-entity>
        </a-entity>

        <!--<a-entity id="b26" position="0.20 0.6 -1.85">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b25" position="0.45 0.6 -1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b24" position="0.70 0.6 -1.95">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b21" position="0.95 0.6 -2">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b22" position="1.20 0.6 -1.95">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b23" position="-1.45 -0.5 -1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>
        <a-entity id="b28" position="-1.45 -0.2 -1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>
        <a-entity id="b29" position="-1.70 -0.2 -1.85">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>
        <a-entity id="b30" position="-1.45 0.1 -1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>
        <a-entity id="b31" position="-1.70 0.1 -1.85">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b27" position="-1.70 -0.5 -1.85">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity> -->

        
        <a-entity class="ground" geometry="primitive:plane; width:14; height:14;" material="color:white; opacity: 0.2"
            position="0 0.01 0" rotation="0 0 0">
        <!--<a-cylinder position="0 0.05 0" material="color: #FFC65D; transparent: true; opacity: 0.3" geometry="primitive:cylinder;radius:0.5;height=1.0"></a-cylinder>
        <a-cylinder position="-1 0.05 0" material="color: #FFC65D; transparent: true; opacity: 0.3" geometry="primitive:cylinder;radius:0.5;height=1.0"></a-cylinder>-->

        <a-entity id="b1" position="0.7 0 1">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b2" position="1.0 0 0.6">
            <a-entity class="button interactive" pmixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b3" position="1.8 0 0">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b4" position="2.5 0 1">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b5" position="3.0 0 1.5">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b6" position="3.2 0 2.5">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b7" position="3.6 0 2.64">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b8" position="4.2 0 1.1">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b9" position="4.5 0 1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b10" position="5.0 0 2.1">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b11" position="5.4 0 2.2">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b12" position="2.7.0 0 2.5">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b13" position="-1 0 0">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b14" position="-0.6 0 1">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b15" position="-1.2 0 1.4">
            <a-entity class="button interactive" pmixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b16" position="-1.7 0 1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b17" position="-2 0 2.2">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b18" position="5.3 0 1.4">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b19" position="3.7 0 1.9">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>

        <a-entity id="b20" position="2.1 0 2.4">
            <a-entity class="button interactive" mixin="sphere"></a-entity>
        </a-entity>
        </a-entity>>
    </a-scene>

    <!-- 2 javascript files; server side, (first one)client side -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io();
        let player = 2;
        let xoffset = 0.20;
        let yoffset = -0.5;
        let zoffset = -2.0;
        let offset = 0;

        socket.on('connect', (userData) => {
            console.log("I exist!");

            document.querySelector("#playtogather").querySelector(".button").addEventListener("click", function () {
                player = 1;
                socket.emit('playGame', { player: 1, togather: true })
            });

            document.querySelector("#playagainst").querySelector(".button").addEventListener("click", function () {
                player = 1;
                socket.emit('playGame', { player: 1, togather: false })
            });
            socket.on('changeColorTogather', (data) => {
                let ids = "b" + (data)
                var btn = document.getElementById(ids).querySelector(".button");
                btn.setAttribute('material', "color:rgb(255, 0, 0)");
                btn.disabled = true
            });

            socket.on('collectBallComp', (data) => {
                let ids = "b" + (data.btn)
                var btn = document.getElementById(ids).querySelector(".button");
                console.log(data.x, data.y, data.z);
                //btn.setAttribute('position', {x:data.x, y:data.y, z:data.z});
                btn.setAttribute('material', data.colr);
                btn.setAttribute('rotation', "-90 0 0");
                btn.disabled = true
            });

            socket.on('playGameAll', (data) => {
                var btn = document.getElementById("playagainst").querySelector(".button");
                var btn2 = document.getElementById("playtogather").querySelector(".button");
                btn.disabled = true;
                btn2.disabled = true;
                if (data.togather) {
                    for (let i = 0; i < 20; i++) {
                        let ids = "#b" + (i + 1);
                        document.querySelector(ids).querySelector(".button").addEventListener("click", function () {
                            console.log("local var " + i)
                            socket.emit('changeColor', (i + 1));
                        });
                    }
                }
                else {
                    for (let i = 0; i < 20; i++) {
                        let ids = "#b" + (i + 1);
                        document.querySelector(ids).querySelector(".button").addEventListener("click", function () {
                            console.log("local var " + i)
                            let btmpos = (300 * offset) + 10 + "px"
                            let zaxis = zoffset;
                            let xaxis = xoffset;
                            let yaxis = yoffset;
                            zoffset = (zoffset + 0.05)
                            if (zoffset == -1.80)
                            {
                                zoffset = -2.0;
                            }
                            offset = (1+ offset)
                            let rightpos = "10px"
                            let clr = "color:rgb(0, 255, 255)";
                            if (player == 2) {
                                clr = "color:rgb(255, 0, 255)";
                                xaxis = -xoffset;
                                rightpos = "6500px"
                            }
                            xoffset = (xoffset + 0.25)
                            if (xoffset == 1.95)
                            {
                                xoffset = 0.20;
                                yoffset = (yoffset + 0.3);
                            }

                            socket.emit('collectBall', { btn: (i + 1), bottom: btmpos, right: rightpos, x: xaxis, y: yaxis, z: zaxis, colr: clr });
                        });
                    }
                }
                
                // Update the count down every 1 second
                var nowT = new Date(Date.now()+30*1000).getTime()
                
                var x = setInterval(function () {

                    // Get today's date and time
                    var now = new Date().getTime();

                    // Find the distance between now and the count down date
                    var distance = nowT - now;
                    console.log(nowT);

                    // Time calculations for days, hours, minutes and seconds
                    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    // Display the result in the element with id="demo"
                    document.getElementById("timer").setAttribute('text',  "align: center; width: 1; font: https://cdn.aframe.io/fonts/Aileron-Semibold.fnt; value: " + seconds + "s ");

                    // If the count down is finished, write some text
                    if (distance < 0) {
                        clearInterval(x);
                        document.getElementById("timer").setAttribute('text',  "align: center; width: 1; font: https://cdn.aframe.io/fonts/Aileron-Semibold.fnt; value: EXPIRED");
                        for (let i = 0; i < 20; i++) {
                            let ids = "b" + (i + 1);
                            btn = document.getElementById(ids).querySelector(".button");
                            btn.disabled = true
                        }
                    }
                }, 1000);
            });
        });

    </script>
</body>

</html>